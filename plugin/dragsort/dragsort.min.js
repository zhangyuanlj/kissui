!function(a){a.fn.dragsort=function(b){var c,d,e,f;return"destroy"==b?(a(this.selector).trigger("dragsort-uninit"),void 0):(c=a.extend({},a.fn.dragsort.defaults,b),d=[],e=null,f=null,this.each(function(b,g){a(g).is("table")&&1==a(g).children().size()&&a(g).children().is("tbody")&&(g=a(g).children().get(0));var h={draggedItem:null,placeHolderItem:null,pos:null,offset:null,offsetLimit:null,scroll:null,container:g,init:function(){var d=0==a(this.container).children().size()?"li":a(this.container).children(":first").get(0).tagName.toLowerCase();""==c.itemSelector&&(c.itemSelector=d),""==c.dragSelector&&(c.dragSelector=d),""==c.placeHolderTemplate&&(c.placeHolderTemplate="<"+d+">&nbsp;</"+d+">"),a(this.container).attr("data-listidx",b).mousedown(this.grabItem).bind("dragsort-uninit",this.uninit),this.styleDragHandlers(!0)},uninit:function(){var b=d[a(this).attr("data-listidx")];a(b.container).unbind("mousedown",b.grabItem).unbind("dragsort-uninit"),b.styleDragHandlers(!1)},getItems:function(){return a(this.container).children(c.itemSelector)},styleDragHandlers:function(b){this.getItems().map(function(){return a(this).is(c.dragSelector)?this:a(this).find(c.dragSelector).get()}).css("cursor",b?"pointer":"")},grabItem:function(b){var e,f,g,h;if(!(1!=b.which||a(b.target).is(c.dragSelectorExclude)||a(b.target).closest(c.dragSelectorExclude).size()>0||0==a(b.target).closest(c.itemSelector).size())){for(e=b.target;!a(e).is(c.dragSelector);){if(e==this)return;e=e.parentNode}a(e).attr("data-cursor",a(e).css("cursor")),a(e).css("cursor","move"),f=d[a(this).attr("data-listidx")],g=this,h=function(){f.dragStart.call(g,b),a(f.container).unbind("mousemove",h)},a(f.container).mousemove(h).mouseup(function(){a(f.container).unbind("mousemove",h),a(e).css("cursor",a(e).attr("data-cursor"))}),b.stopPropagation()}},dragStart:function(b){var f,g,h,i,j,k,l;null!=e&&null!=e.draggedItem&&e.dropItem(),e=d[a(this).attr("data-listidx")],e.draggedItem=a(b.target).closest(c.itemSelector),e.draggedItem.attr("data-origpos",a(this).attr("data-listidx")+"-"+e.getItems().index(e.draggedItem)),f=parseInt(e.draggedItem.css("marginTop")),g=parseInt(e.draggedItem.css("marginLeft")),e.offset=e.draggedItem.offset(),e.offset.top=b.pageY-e.offset.top+(isNaN(f)?0:f)-1,e.offset.left=b.pageX-e.offset.left+(isNaN(g)?0:g)-1,c.dragBetween||(h=0==a(e.container).outerHeight()?Math.max(1,Math.round(.5+e.getItems().size()*e.draggedItem.outerWidth()/a(e.container).outerWidth()))*e.draggedItem.outerHeight():a(e.container).outerHeight(),e.offsetLimit=a(e.container).offset(),e.offsetLimit.right=e.offsetLimit.left+a(e.container).outerWidth()-e.draggedItem.outerWidth(),e.offsetLimit.bottom=e.offsetLimit.top+h-e.draggedItem.outerHeight()),i=e.draggedItem.height(),j=e.draggedItem.width(),"tr"==c.itemSelector?(e.draggedItem.children().each(function(){a(this).width(a(this).width())}),e.placeHolderItem=e.draggedItem.clone().attr("data-placeholder",!0),e.draggedItem.after(e.placeHolderItem),e.placeHolderItem.children().each(function(){a(this).css({borderWidth:0,width:a(this).width()+1,height:a(this).height()+1}).html("&nbsp;")})):(e.draggedItem.after(c.placeHolderTemplate),e.placeHolderItem=e.draggedItem.next().css({height:i,width:j}).attr("data-placeholder",!0)),"td"==c.itemSelector&&(k=e.draggedItem.closest("table").get(0),a("<table id='"+k.id+"' style='border-width: 0px;' class='dragSortItem "+k.className+"'><tr></tr></table>").appendTo("body").children().append(e.draggedItem)),l=e.draggedItem.attr("style"),e.draggedItem.attr("data-origstyle",l?l:""),e.draggedItem.css({position:"absolute",opacity:.8,"z-index":999,height:i,width:j}),e.scroll={moveX:0,moveY:0,maxX:a(document).width()-a(window).width(),maxY:a(document).height()-a(window).height()},e.scroll.scrollY=window.setInterval(function(){if(c.scrollContainer!=window)return a(c.scrollContainer).scrollTop(a(c.scrollContainer).scrollTop()+e.scroll.moveY),void 0;var b=a(c.scrollContainer).scrollTop();(e.scroll.moveY>0&&b<e.scroll.maxY||e.scroll.moveY<0&&b>0)&&(a(c.scrollContainer).scrollTop(b+e.scroll.moveY),e.draggedItem.css("top",e.draggedItem.offset().top+e.scroll.moveY+1))},10),e.scroll.scrollX=window.setInterval(function(){if(c.scrollContainer!=window)return a(c.scrollContainer).scrollLeft(a(c.scrollContainer).scrollLeft()+e.scroll.moveX),void 0;var b=a(c.scrollContainer).scrollLeft();(e.scroll.moveX>0&&b<e.scroll.maxX||e.scroll.moveX<0&&b>0)&&(a(c.scrollContainer).scrollLeft(b+e.scroll.moveX),e.draggedItem.css("left",e.draggedItem.offset().left+e.scroll.moveX+1))},10),a(d).each(function(a,b){b.createDropTargets(),b.buildPositionTable()}),e.setPos(b.pageX,b.pageY),a(document).bind("mousemove",e.swapItems),a(document).bind("mouseup",e.dropItem),c.scrollContainer!=window&&a(window).bind("DOMMouseScroll mousewheel",e.wheel)},setPos:function(b,d){var h,i,f=d-this.offset.top,g=b-this.offset.left;c.dragBetween||(f=Math.min(this.offsetLimit.bottom,Math.max(f,this.offsetLimit.top)),g=Math.min(this.offsetLimit.right,Math.max(g,this.offsetLimit.left))),this.draggedItem.parents().each(function(){if("static"!=a(this).css("position")&&(!a.browser.mozilla||"table"!=a(this).css("display"))){var b=a(this).offset();return f-=b.top,g-=b.left,!1}}),c.scrollContainer==window?(d-=a(window).scrollTop(),b-=a(window).scrollLeft(),d=Math.max(0,d-a(window).height()+5)+Math.min(0,d-5),b=Math.max(0,b-a(window).width()+5)+Math.min(0,b-5)):(h=a(c.scrollContainer),i=h.offset(),d=Math.max(0,d-h.height()-i.top)+Math.min(0,d-i.top),b=Math.max(0,b-h.width()-i.left)+Math.min(0,b-i.left)),e.scroll.moveX=0==b?0:b*c.scrollSpeed/Math.abs(b),e.scroll.moveY=0==d?0:d*c.scrollSpeed/Math.abs(d),this.draggedItem.css({top:f,left:g})},wheel:function(b){var d,f,g;(a.browser.safari||a.browser.mozilla)&&e&&c.scrollContainer!=window&&(d=a(c.scrollContainer),f=d.offset(),b.pageX>f.left&&b.pageX<f.left+d.width()&&b.pageY>f.top&&b.pageY<f.top+d.height()&&(g=b.detail?5*b.detail:b.wheelDelta/-2,d.scrollTop(d.scrollTop()+g),b.preventDefault()))},buildPositionTable:function(){var b=[];this.getItems().not([e.draggedItem[0],e.placeHolderItem[0]]).each(function(c){var d=a(this).offset();d.right=d.left+a(this).outerWidth(),d.bottom=d.top+a(this).outerHeight(),d.elm=this,b[c]=d}),this.pos=b},dropItem:function(){if(null!=e.draggedItem){var b=e.draggedItem.attr("data-origstyle");return e.draggedItem.attr("style",b),""==b&&e.draggedItem.removeAttr("style"),e.draggedItem.removeAttr("data-origstyle"),e.styleDragHandlers(!0),e.placeHolderItem.before(e.draggedItem),e.placeHolderItem.remove(),a("[data-droptarget], .dragSortItem").remove(),window.clearInterval(e.scroll.scrollY),window.clearInterval(e.scroll.scrollX),e.draggedItem.attr("data-origpos")!=a(d).index(e)+"-"+e.getItems().index(e.draggedItem)&&c.dragEnd.apply(e.draggedItem),e.draggedItem.removeAttr("data-origpos"),e.draggedItem=null,a(document).unbind("mousemove",e.swapItems),a(document).unbind("mouseup",e.dropItem),c.scrollContainer!=window&&a(window).unbind("DOMMouseScroll mousewheel",e.wheel),!1}},swapItems:function(b){var g,h,i,j,k;if(null==e.draggedItem)return!1;for(e.setPos(b.pageX,b.pageY),g=e.findPos(b.pageX,b.pageY),h=e,i=0;-1==g&&c.dragBetween&&i<d.length;i++)g=d[i].findPos(b.pageX,b.pageY),h=d[i];return-1==g?!1:(j=function(){return a(h.container).children().not(h.draggedItem)},k=j().not(c.itemSelector).each(function(){this.idx=j().index(this)}),null==f||f.top>e.draggedItem.offset().top||f.left>e.draggedItem.offset().left?a(h.pos[g].elm).before(e.placeHolderItem):a(h.pos[g].elm).after(e.placeHolderItem),k.each(function(){var b=j().eq(this.idx).get(0);this!=b&&j().index(this)<this.idx?a(this).insertAfter(b):this!=b&&a(this).insertBefore(b)}),a(d).each(function(a,b){b.createDropTargets(),b.buildPositionTable()}),f=e.draggedItem.offset(),!1)},findPos:function(a,b){for(var c=0;c<this.pos.length;c++)if(this.pos[c].left<a&&this.pos[c].right>a&&this.pos[c].top<b&&this.pos[c].bottom>b)return c;return-1},createDropTargets:function(){c.dragBetween&&a(d).each(function(){var b=a(this.container).find("[data-placeholder]"),d=a(this.container).find("[data-droptarget]");b.size()>0&&d.size()>0?d.remove():0==b.size()&&0==d.size()&&("td"==c.itemSelector?a(c.placeHolderTemplate).attr("data-droptarget",!0).appendTo(this.container):a(this.container).append(e.placeHolderItem.removeAttr("data-placeholder").clone().attr("data-droptarget",!0)),e.placeHolderItem.attr("data-placeholder",!0))})}};h.init(),d.push(h)}),this)},a.fn.dragsort.defaults={itemSelector:"",dragSelector:"",dragSelectorExclude:"input, textarea",dragEnd:function(){},dragBetween:!1,placeHolderTemplate:"",scrollContainer:window,scrollSpeed:5}}(jQuery);