!function(a){var b={init:function(c){return this.each(function(){var f,d=a(this),e=d.data("eraser");e||(f=function(){var f=a("<canvas/>"),g=f.get(0),h=g.getContext("2d"),i=window.devicePixelRatio||1,j=h.webkitBackingStorePixelRatio||h.mozBackingStorePixelRatio||h.msBackingStorePixelRatio||h.oBackingStorePixelRatio||h.backingStorePixelRatio||1,k=i/j,l=d.width(),m=d.height(),n=l*k,o=m*k,p=d.offset(),q=(c&&c.size?c.size:40)*k,r=c&&c.completeRatio?c.completeRatio:.7,s=c&&c.completeFunction?c.completeFunction:null,t=c&&c.progressFunction?c.progressFunction:null,u="auto"==d.css("z-index")?1:d.css("z-index"),v=[],w=Math.floor(n/q),x=w*Math.floor(o/q),y=x,z=d[0];for(d.after(f),g.id=z.id,g.className=z.className,g.width=n,g.height=o,g.style.width=l.toString()+"px",g.style.height=m.toString()+"px",h.drawImage(z,0,0),d.remove(),h.globalCompositeOperation="destination-out",h.strokeStyle="rgba(255,0,0,255)",h.lineWidth=q,h.lineCap="round",f.bind("mousedown.eraser",b.mouseDown),f.bind("touchstart.eraser",b.touchStart),f.bind("touchmove.eraser",b.touchMove),f.bind("touchend.eraser",b.touchEnd);y--;)v.push(1);e={posX:p.left,posY:p.top,touchDown:!1,touchID:-999,touchX:0,touchY:0,ptouchX:0,ptouchY:0,canvas:f,ctx:h,w:n,h:o,scaleRatio:k,source:z,size:q,parts:v,colParts:w,numParts:x,ratio:0,complete:!1,completeRatio:r,completeFunction:s,progressFunction:t,zIndex:u},f.data("eraser",e),a(window).resize(function(){var a=f.offset();e.posX=a.left,e.posY=a.top})},this.complete&&this.naturalWidth>0?f():d.load(f))})},touchStart:function(c){var f,g,h,d=a(this),e=d.data("eraser");e.touchDown||(f=c.originalEvent.changedTouches[0],g=f.pageX-e.posX,h=f.pageY-e.posY,g*=e.scaleRatio,h*=e.scaleRatio,b.evaluatePoint(e,g,h),e.touchDown=!0,e.touchID=f.identifier,e.touchX=g,e.touchY=h,c.preventDefault())},touchMove:function(c){var f,g,h,i,d=a(this),e=d.data("eraser");if(e.touchDown)for(f=c.originalEvent.changedTouches,g=f.length;g--;)if(f[g].identifier==e.touchID){h=f[g].pageX-e.posX,i=f[g].pageY-e.posY,h*=e.scaleRatio,i*=e.scaleRatio,b.evaluatePoint(e,h,i),e.ctx.beginPath(),e.ctx.moveTo(e.touchX,e.touchY),e.touchX=h,e.touchY=i,e.ctx.lineTo(e.touchX,e.touchY),e.ctx.stroke(),d.css({"z-index":d.css("z-index")==e.zIndex?parseInt(e.zIndex)+1:e.zIndex}),c.preventDefault();break}},touchEnd:function(b){var e,f,c=a(this),d=c.data("eraser");if(d.touchDown)for(e=b.originalEvent.changedTouches,f=e.length;f--;)if(e[f].identifier==d.touchID){d.touchDown=!1,b.preventDefault();break}},evaluatePoint:function(a,b,c){var d=Math.floor(b/a.size)+Math.floor(c/a.size)*a.colParts;d>=0&&d<a.numParts&&(a.ratio+=a.parts[d],a.parts[d]=0,a.complete||(d=a.ratio/a.numParts,d>=a.completeRatio?(a.complete=!0,null!=a.completeFunction&&a.completeFunction()):null!=a.progressFunction&&a.progressFunction(d)))},mouseDown:function(c){var d=a(this),e=d.data("eraser"),f=c.pageX-e.posX,g=c.pageY-e.posY;f*=e.scaleRatio,g*=e.scaleRatio,b.evaluatePoint(e,f,g),e.touchDown=!0,e.touchX=f,e.touchY=g,e.ctx.beginPath(),e.ctx.moveTo(e.touchX-1,e.touchY),e.ctx.lineTo(e.touchX,e.touchY),e.ctx.stroke(),d.bind("mousemove.eraser",b.mouseMove),a(document).bind("mouseup.eraser",e,b.mouseUp),c.preventDefault()},mouseMove:function(c){var d=a(this),e=d.data("eraser"),f=c.pageX-e.posX,g=c.pageY-e.posY;f*=e.scaleRatio,g*=e.scaleRatio,b.evaluatePoint(e,f,g),e.ctx.beginPath(),e.ctx.moveTo(e.touchX,e.touchY),e.touchX=f,e.touchY=g,e.ctx.lineTo(e.touchX,e.touchY),e.ctx.stroke(),d.css({"z-index":d.css("z-index")==e.zIndex?parseInt(e.zIndex)+1:e.zIndex}),c.preventDefault()},mouseUp:function(b){var c=b.data,d=c.canvas;c.touchDown=!1,d.unbind("mousemove.eraser"),a(document).unbind("mouseup.eraser"),b.preventDefault()},clear:function(){var d,b=a(this),c=b.data("eraser");if(c){for(c.ctx.clearRect(0,0,c.w,c.h),d=c.numParts;d--;)c.parts[d]=0;c.ratio=c.numParts,c.complete=!0,null!=c.completeFunction&&c.completeFunction()}},size:function(b){var c=a(this),d=c.data("eraser");d&&b&&(d.size=b,d.ctx.lineWidth=b)},reset:function(){var d,b=a(this),c=b.data("eraser");if(c){for(c.ctx.globalCompositeOperation="source-over",c.ctx.drawImage(c.source,0,0),c.ctx.globalCompositeOperation="destination-out",d=c.numParts;d--;)c.parts[d]=1;c.ratio=0,c.complete=!1,c.touchDown=!1}},progress:function(){var b=a(this),c=b.data("eraser");return c?c.ratio/c.numParts:0}};a.fn.eraser=function(c){return b[c]?b[c].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof c&&c?(a.error("Method "+c+" does not yet exist on jQuery.eraser"),void 0):b.init.apply(this,arguments)}}(jQuery);